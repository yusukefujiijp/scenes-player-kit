{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://scenes-player/schema/v6.1.0",
  "title": "Scenes Player Script Schema v6.1.0 (Gate NG Fix / Master Prompt V3.9 Soul Compliant)",
  "description": "V6.1.0: Gate NG (scene[0] text) 修正。scene[0] (placeholder) の title/narr/TTSを「空文字必須」に。V3.9 の「魂」に準拠。tags=3個固定, symbol=3個固定, yoon=katakana-plus-choon（ショー）, kakko-bug=禁止。",
  "type": "object",

  "properties": {
    "doc": {
      "type": "object",
      "description": "台本自身が運用ルール・意図・手順を内包する自己記述ブロック。AI はスレッドごとに忘れても、この台本は覚えている。",
      "properties": {
        "version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$" },
        "lastUpdated": { "type": "string", "format": "date-time" },
        "rulesMd": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
        "checklist": { "type": "array", "items": { "type": "string" } },
        "meta": {
          "type": "object",
          "properties": {
            "manifestoMd": { "type": "array", "items": { "type": "string" } }
          },
          "additionalProperties": true
        },
        "oneShot": {
          "type": "array",
          "description": "将来の生成AIに渡す理想的 One-Shot（Markdown 行の配列）。この台本だけで振る舞いを再現できるようにする。",
          "items": { "type": "string" }
        }
      },
      "required": ["version", "lastUpdated", "rulesMd"],
      "additionalProperties": true
    },

    "videoMeta": {
      "type": "object",
      "description": "作品メタ。順序は doc → videoMeta → tts → scenes の並びを推奨（検証順ではなく“読む順”）。",
      "properties": {
        "dossierId": { "type": "string", "pattern": "^[A-Za-z0-9._-]+$" },
        "creationTimestamp": { "type": "string", "format": "date-time" },
        "theme": { "type": "string" },
        "triviaTitle": { "type": "string" },
        "thumbnailText": { "type": "string", "maxLength": 25 },
        "bannerText": { "type": "string", "maxLength": 20 },

        "meta": {
          "type": "object",
          "properties": {
            "subTheme": { "type": "string" },
            "tts": {
              "type": "object",
              "description": "(Legacy) 後方互換のため残置。推奨は top-level tts に一本化。",
              "properties": {
                "filter": {
                  "type": "object",
                  "properties": { "jaOnly": { "type": "boolean", "default": true } },
                  "additionalProperties": false
                }
              },
              "additionalProperties": true
            }
          },
          "additionalProperties": true
        },

        "tts": {
          "type": "object",
          "description": "(Legacy) 後方互換（推奨は top-level tts）。",
          "properties": {
            "lang": { "type": "string" },
            "voicePreferences": { "type": "array", "items": { "type": "string" } },
            "rate": { "type": "number", "minimum": 0.5, "maximum": 2.0 },
            "filter": {
              "type": "object",
              "properties": { "jaOnly": { "type": "boolean", "default": true } },
              "additionalProperties": false
            }
          },
          "additionalProperties": true
        },

        "ui": {
          "type": "object",
          "properties": {
            "a11y": {
              "type": "object",
              "properties": { "prefersReducedMotion": { "type": "boolean", "default": false } },
              "additionalProperties": false
            }
          },
          "additionalProperties": true
        },

        "advancePolicy": {
          "type": "object",
          "description": "グローバル既定。mode=auto/manual、quietMs は読了後の無音監視、postDelayMs は余韻。",
          "properties": {
            "mode": { "type": "string", "enum": ["auto", "manual"], "default": "auto" },
            "quietMs": { "type": "integer", "minimum": 0, "default": 350 },
            "postDelayMs": { "type": "integer", "minimum": 0, "default": 300 }
          },
          "additionalProperties": false
        },

        "contract": {
          "type": "object",
          "properties": {
            "structure": {
              "type": "object",
              "properties": {
                "requireOpeningEffect": { "type": "boolean", "default": true },
                "requireTransitionT": { "type": "boolean", "default": true },
                "requireClosingEffect": { "type": "boolean", "default": true },
                "minA": { "type": "integer", "minimum": 0, "default": 1 },
                "minB": { "type": "integer", "minimum": 0, "default": 0 },
                "scripturePrologueIntro": { "type": "boolean", "default": false }
              },
              "additionalProperties": false
            },
            "versionThemeMap": {
              "type": "object",
              "properties": {
                "A": { "type": "string", "enum": ["light", "dark"], "default": "dark" },
                "B": { "type": "string", "enum": ["light", "dark"], "default": "dark" },
                "T": { "type": "string", "enum": ["light", "dark"], "default": "dark" }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": true
        }
      },
      "required": ["dossierId", "theme", "thumbnailText"],
      "additionalProperties": true
    },

    "tts": {
      "type": "object",
      "description": "TTS 設定の単一ハブ。ポリシは js/tts-sanitize.js と連動し、iPhone Safari の挙動に最適化。",
      "properties": {
        "lang": { "type": "string", "default": "ja-JP" },
        "rate": { "type": "number", "minimum": 0.5, "maximum": 2.0 },
        "voicePreferences": { "type": "array", "items": { "type": "string" } },
        "filter": {
          "type": "object",
          "properties": { "jaOnly": { "type": "boolean", "default": true } },
          "additionalProperties": false
        },
        "policy": {
          "type": "object",
          "description": "TTS 整形ポリシ。mirror=表示と読みの意味一致。句読点休止と拗音変換を制御 (V3.9 準拠)。",
          "properties": {
            "mode": { "type": "string", "enum": ["mirror", "free"], "default": "mirror" },
            "commaPause": { "type": "string", "enum": ["space2", "none"], "default": "space2" },
            "periodPause": { "type": "string", "enum": ["zspaceIfNeeded", "none"], "default": "zspaceIfNeeded" },
            "yoon": { "type": "string", "enum": ["katakana", "katakana-plus-choon", "none"], "default": "katakana-plus-choon" },
            "activation": {
              "type": "object",
              "properties": {
                "page1": { "type": "string", "enum": ["visualOnly"], "default": "visualOnly" }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": true
    },

    "scenes": {
      "description": "先頭は必ず Play専用の placeholder（音声なし）。以降は content/effect。",
      "allOf": [
        { "$ref": "#/$defs/scenesCore" },
        { "$ref": "#/$defs/minPages_12" }
      ]
    }
  },

  "required": ["doc", "videoMeta", "scenes"],
  "additionalProperties": false,

  "allOf": [
    {
      "description": "opening が少なくとも1枚存在",
      "properties": {
        "scenes": {
          "type": "array",
          "contains": {
            "type": "object",
            "properties": { "type": { "const": "effect" }, "effectRole": { "const": "opening" } },
            "required": ["type", "effectRole"]
          }
        }
      }
    },
    {
      "description": "transition が少なくとも1枚存在",
      "properties": {
        "scenes": {
          "type": "array",
          "contains": {
            "type": "object",
            "properties": { "type": { "const": "effect" }, "effectRole": { "const": "transition" } },
            "required": ["type", "effectRole"]
          }
        }
      }
    },
    {
      "description": "closing が少なくとも1枚存在（作品によっては省略可だが既定は要求）",
      "properties": {
        "scenes": {
          "type": "array",
          "contains": {
            "type": "object",
            "properties": { "type": { "const": "effect" }, "effectRole": { "const": "closing" } },
            "required": ["type", "effectRole"]
          }
        }
      }
    },
    {
      "description": "scripturePrologueIntro=true の時、items[2]=Page3 Scripture, items[3]=Page4 Prologue を強制",
      "if": {
        "properties": {
          "videoMeta": {
            "properties": {
              "contract": {
                "properties": {
                  "structure": {
                    "properties": { "scripturePrologueIntro": { "const": true } },
                    "required": ["scripturePrologueIntro"]
                  }
                },
                "required": ["structure"]
              }
            },
            "required": ["contract"]
          }
        },
        "required": ["videoMeta"]
      },
      "then": {
        "properties": {
          "scenes": {
            "items": [
              {},
              {},
              {
                "allOf": [
                  { "$ref": "#/$defs/contentScene" },
                  {
                    "properties": {
                      "page": { "const": "3" },
                      "version": { "const": "A" },
                      "sectionTags": { "type": "array", "contains": { "const": "#Scripture" } }
                    },
                    "required": ["page", "version", "sectionTags"]
                  }
                ]
              },
              {
                "allOf": [
                  { "$ref": "#/$defs/contentScene" },
                  {
                    "properties": {
                      "page": { "const": "4" },
                      "version": { "const": "A" },
                      "sectionTags": { "type": "array", "contains": { "const": "#Prologue" } }
                    },
                    "required": ["page", "version", "sectionTags"]
                  }
                ]
              }
            ]
          }
        }
      }
    }
  ],

  "$defs": {
    "pageId": { "type": "string", "pattern": "^[1-9][0-9]*$" },
    "hexColor": { "type": "string", "pattern": "^#[0-9a-fA-F]{6}$" },

    "sectionTagTokenAny": {
      "type": "string",
      "pattern": "^#[A-Za-z0-9][A-Za-z0-9_-]{0,23}$"
    },

    "sectionTags": {
      "type": "array",
      "items": { "$ref": "#/$defs/sectionTagTokenAny" },
      "uniqueItems": true,
      "minItems": 3,
      "maxItems": 3,
      "description": "V3.9 規則: 3個固定（1.1.11）"
    },

    "placeholderScene": {
      "type": "object",
      "description": "Page-1 のアクティベーション・ゲート（音声なし・表示のみ）。V6.1.0: Gate NG回避のため、title/narr/TTSは全て空文字（\"\"）固定。",
      "properties": {
        "page": { "$ref": "#/$defs/pageId" },
        "type": { "type": "string", "const": "placeholder" },
        "title": { "type": "string", "maxLength": 0, "default": "" },
        "titleTTS": { "type": "string", "maxLength": 0, "default": "" },
        "narr": { "type": "string", "maxLength": 0, "default": "" },
        "narrTTS": { "type": "string", "maxLength": 0, "default": "" },
        "base": { "$ref": "#/$defs/hexColor" }
      },
      "required": ["page", "type", "title", "titleTTS", "narr", "narrTTS"],
      "additionalProperties": false
    },

    "contentScene": {
      "type": "object",
      "description": "本文を持つ通常シーン（A/B/T）。二層TTS（*TTS）を必須。symbol には絵文字・顔文字の使用を強く推奨。TTS では絵文字は黙らせるが、表示は保持。",
      "properties": {
        "page": { "$ref": "#/$defs/pageId" },
        "type": { "type": "string", "const": "content" },
        "version": { "type": "string", "enum": ["A", "B", "T"] },

        "sectionTags": { "$ref": "#/$defs/sectionTags" },

        "title_key": { "type": "string", "pattern": "^\\u3010.+\\u3011$", "minLength": 2, "maxLength": 20 },
        "titleKeyTTS": { 
          "type": "string", 
          "minLength": 0, 
          "description": "タイトル鍵の読み（V3.8: カッコ禁止）。",
          "not": { "pattern": "カッコ" }
        },

        "title": { "type": "string", "minLength": 1, "maxLength": 28 },
        "titleTTS": { 
          "type": "string", 
          "minLength": 1,
          "not": { "pattern": "カッコ" }
        },

        "symbol": {
          "type": "string",
          "minLength": 3,
          "maxLength": 3,
          "description": "V3.9 規則: [AI][Face][Hand] 絵文字3個固定（1.4.3）。"
        },

        "base": { "$ref": "#/$defs/hexColor" },

        "narr": { "type": "string", "maxLength": 280, "description": "表示用本文。改行（\\n）を推奨（V3.9: 必須ではない）。" },
        "narrTTS": {
          "type": "string",
          "description": "読み用本文（mirror）。V3.8: カッコ禁止。",
          "not": { "pattern": "カッコ" }
        },

        "effect": { "type": "string", "enum": ["light-in", "fade-in", "slide-up", "zoom-in"] },
        "durationHintMs": { "type": "integer", "minimum": 0 },

        "advancePolicy": {
          "type": "object",
          "description": "シーン個別の上書き。未指定時は videoMeta.advancePolicy を継承。",
          "properties": {
            "mode": { "type": "string", "enum": ["auto", "manual"] },
            "quietMs": { "type": "integer", "minimum": 0 },
            "postDelayMs": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        }
      },
      "required": [
        "page",
        "type",
        "version",
        "sectionTags",
        "title_key",
        "titleKeyTTS",
        "title",
        "titleTTS",
        "symbol",
        "base",
        "narr",
        "narrTTS"
      ],
      "additionalProperties": false,
      "allOf": [
        {
          "description": "長文>=80では段落推奨（\\n\\n）",
          "if": { "properties": { "narr": { "minLength": 80 } }, "required": ["narr"] },
          "then": { "properties": { "narr": { "pattern": ".*\\n\\n.*" } } }
        }
      ]
    },

    "effectScene": {
      "type": "object",
      "description": "純エフェクト。本文キーは禁止（symbol も禁止）。時間キーは t|duration|durationMs|effectDuration のいずれでも可。",
      "properties": {
        "page": { "$ref": "#/$defs/pageId" },
        "type": { "type": "string", "const": "effect" },
        "effect": {
          "type": "string",
          "enum": ["light-in", "fade-in", "fade-to-black", "flame-out", "veil-sweep", "slow-bloom", "slide-up", "zoom-in"]
        },
        "effectRole": { "type": "string", "enum": ["opening", "transition", "closing"] },
        "uiVersion": { "type": "string", "enum": ["A", "B", "T"] },
        "base": { "$ref": "#/$defs/hexColor" },

        "t": { "type": "integer", "minimum": 0 },
        "duration": { "type": "integer", "minimum": 0 },
        "durationMs": { "type": "integer", "minimum": 0 },
        "effectDuration": { "type": "integer", "minimum": 0 },

        "advancePolicy": {
          "type": "object",
          "description": "エフェクト終了後の挙動。未指定時は videoMeta.advancePolicy を継承。",
          "properties": {
            "mode": { "type": "string", "enum": ["auto", "manual"] },
            "quietMs": { "type": "integer", "minimum": 0 },
            "postDelayMs": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        }
      },
      "required": ["page", "type", "effect", "base"],
      "additionalProperties": false,
      "allOf": [
        {
          "description": "本文キーは禁止（symbol/title/narr など）",
          "not": {
            "anyOf": [
              { "required": ["title_key"] },
              { "required": ["titleKeyTTS"] },
              { "required": ["title"] },
              { "required": ["titleTTS"] },
              { "required": ["symbol"] },
              { "required": ["narr"] },
              { "required": ["narrTTS"] },
              { "required": ["sectionTags"] }
            ]
          }
        }
      ]
    },

    "scenesCore": {
      "type": "array",
      "description": "scenes の本体定義：先頭は placeholder(page=1)、以降は content/effect。",
      "items": [
        {
          "allOf": [
            { "$ref": "#/$defs/placeholderScene" },
            { "properties": { "page": { "const": "1" } }, "required": ["page"] }
          ]
        }
      ],
      "additionalItems": { "oneOf": [ { "$ref": "#/$defs/contentScene" }, { "$ref": "#/$defs/effectScene" } ] }
    },

    "minPages_08": { "type": "array", "minItems": 8 },
    "minPages_10": { "type": "array", "minItems": 10 },
    "minPages_12": { "type": "array", "minItems": 12 },
    "minPages_16": { "type": "array", "minItems": 16 },

    "config": {
      "type": "object",
      "description": "人間用メモ：現在の最低ページ設定に対応する参照。切替は scenes の allOf で minPages_* を差し替える。",
      "properties": {
        "minPagesRef": { "type": "string", "const": "#/$defs/minPages_12" }
      },
      "additionalProperties": true
    }
  }
}
