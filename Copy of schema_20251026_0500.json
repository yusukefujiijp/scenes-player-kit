{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://scenes-player/schema/v5.0.0",
  "title": "Scenes Player Script Schema v5.0.0 (Two-layer TTS, iPhone-first, Emoji/Kaomoji-safe)",
  "description": "このスキーマは『表示(narr/title/title_key) と 読み(narrTTS/titleTTS/titleKeyTTS) の二層』を前提とし、page1 をアクティベーションゲート（音声なし）として固定します。絵文字・顔文字（ビジュアル要素）は表示では歓迎し、TTS 経路では js/tts-sanitize.js により安全に黙殺（無音化）します。TTS の休止・拗音処理ポリシは top-level tts.policy に記述し、実行時に連動します。",

  "type": "object",
  "properties": {
    "doc": {
      "type": "object",
      "description": "台本自身が自分の運用ルールを保持する自己記述ブロック。AI/人間どちらが触っても意図を継承できる“記憶”。ここに絵文字/顔文字の扱い（表示歓迎・TTS黙殺）や、二層TTSの原則、録画前提などを明示する。",
      "properties": {
        "version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$" },
        "lastUpdated": { "type": "string", "format": "date-time" },
        "rulesMd": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
        "checklist": { "type": "array", "items": { "type": "string" } },
        "meta": {
          "type": "object",
          "properties": {
            "manifestoMd": { "type": "array", "items": { "type": "string" } }
          },
          "additionalProperties": true
        }
      },
      "required": ["version", "lastUpdated", "rulesMd"],
      "additionalProperties": true
    },

    "videoMeta": {
      "type": "object",
      "description": "ビデオ/作品全体に関するメタ。UIテーマ・自動遷移ポリシ・構成契約などを含む。",
      "properties": {
        "dossierId": { "type": "string", "pattern": "^[A-Za-z0-9._-]+$" },
        "creationTimestamp": { "type": "string", "format": "date-time" },
        "theme": { "type": "string" },
        "triviaTitle": { "type": "string" },
        "thumbnailText": { "type": "string", "maxLength": 25 },
        "bannerText": { "type": "string", "maxLength": 20 },

        "meta": {
          "type": "object",
          "properties": {
            "subTheme": { "type": "string" },
            "tts": {
              "type": "object",
              "description": "（後方互換）推奨は top-level tts に一本化。",
              "properties": {
                "filter": {
                  "type": "object",
                  "properties": { "jaOnly": { "type": "boolean", "default": true } },
                  "additionalProperties": false
                }
              },
              "additionalProperties": true
            }
          },
          "additionalProperties": true
        },

        "tts": {
          "type": "object",
          "description": "（後方互換）推奨は top-level tts。",
          "properties": {
            "lang": { "type": "string" },
            "voicePreferences": { "type": "array", "items": { "type": "string" } },
            "rate": { "type": "number", "minimum": 0.5, "maximum": 2.0 },
            "filter": {
              "type": "object",
              "properties": { "jaOnly": { "type": "boolean", "default": true } },
              "additionalProperties": false
            }
          },
          "additionalProperties": true
        },

        "ui": {
          "type": "object",
          "properties": {
            "a11y": {
              "type": "object",
              "properties": { "prefersReducedMotion": { "type": "boolean", "default": false } },
              "additionalProperties": false
            }
          },
          "additionalProperties": true
        },

        "advancePolicy": {
          "type": "object",
          "description": "グローバル既定。mode=auto/manual、quietMs は読了後の無音監視、postDelayMs は余韻。",
          "properties": {
            "mode": { "type": "string", "enum": ["auto", "manual"], "default": "auto" },
            "quietMs": { "type": "integer", "minimum": 0, "default": 300 },
            "postDelayMs": { "type": "integer", "minimum": 0, "default": 250 }
          },
          "additionalProperties": false
        },

        "contract": {
          "type": "object",
          "description": "構成契約。どのタイプのエフェクトを必須にするか等を定義。フラグに応じて schema 側の必須性判定が変わる（条件付き）。",
          "properties": {
            "structure": {
              "type": "object",
              "properties": {
                "requireOpeningEffect": { "type": "boolean", "default": true },
                "requireTransitionT": { "type": "boolean", "default": true },
                "requireClosingEffect": { "type": "boolean", "default": true },
                "minA": { "type": "integer", "minimum": 0, "default": 1 },
                "minB": { "type": "integer", "minimum": 0, "default": 0 },
                "scripturePrologueIntro": { "type": "boolean", "default": false }
              },
              "additionalProperties": false
            },
            "versionThemeMap": {
              "type": "object",
              "properties": {
                "A": { "type": "string", "enum": ["light", "dark"], "default": "light" },
                "B": { "type": "string", "enum": ["light", "dark"], "default": "dark" },
                "T": { "type": "string", "enum": ["light", "dark"], "default": "dark" }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": true
        }
      },
      "required": ["dossierId", "theme", "thumbnailText"],
      "additionalProperties": true
    },

    "tts": {
      "type": "object",
      "description": "TTS設定の単一ハブ。js/tts-sanitize.js と連動。拗音のカタカナ化/句読点休止/placeholder無音化などをここで宣言。",
      "properties": {
        "lang": { "type": "string", "default": "ja-JP" },
        "rate": { "type": "number", "minimum": 0.5, "maximum": 2.0 },
        "voicePreferences": { "type": "array", "items": { "type": "string" } },
        "filter": {
          "type": "object",
          "properties": { "jaOnly": { "type": "boolean", "default": true } },
          "additionalProperties": false
        },
        "policy": {
          "type": "object",
          "description": "TTS 整形ポリシ。mirror=表示と読みの意味一致。句読点→休止と拗音→カタカナ変換を制御。絵文字/顔文字は表示歓迎・TTS黙殺（サニタイザ固定動作）。",
          "properties": {
            "mode": { "type": "string", "enum": ["mirror", "free"], "default": "mirror" },
            "commaPause": { "type": "string", "enum": ["space2", "none"], "default": "space2" },
            "periodPause": { "type": "string", "enum": ["zspaceIfNeeded", "none"], "default": "zspaceIfNeeded" },
            "yoon": { "type": "string", "enum": ["katakana", "none"], "default": "katakana" },
            "activation": {
              "type": "object",
              "properties": {
                "page1": { "type": "string", "enum": ["visualOnly"], "default": "visualOnly" }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": true
    },

    "scenes": {
      "type": "array",
      "minItems": 1,
      "description": "先頭は必ず Play専用の placeholder（音声なし/録画時はカット）。以降は content/effect。",
      "items": [
        {
          "allOf": [
            { "$ref": "#/$defs/placeholderScene" },
            { "properties": { "page": { "const": "1" } }, "required": ["page"] }
          ]
        }
      ],
      "additionalItems": { "oneOf": [ { "$ref": "#/$defs/contentScene" }, { "$ref": "#/$defs/effectScene" } ] }
    }
  },

  "required": ["doc", "videoMeta", "scenes"],
  "additionalProperties": false,

  "allOf": [
    {
      "description": "contract.structure.requireOpeningEffect===true のときだけ opening を要求",
      "if": {
        "properties": {
          "videoMeta": {
            "properties": {
              "contract": {
                "properties": {
                  "structure": {
                    "properties": { "requireOpeningEffect": { "const": true } },
                    "required": ["requireOpeningEffect"]
                  }
                },
                "required": ["structure"]
              }
            },
            "required": ["contract"]
          }
        },
        "required": ["videoMeta"]
      },
      "then": {
        "properties": {
          "scenes": {
            "type": "array",
            "contains": {
              "type": "object",
              "properties": { "type": { "const": "effect" }, "effectRole": { "const": "opening" } },
              "required": ["type", "effectRole"]
            }
          }
        }
      }
    },
    {
      "description": "contract.structure.requireTransitionT===true のときだけ transition を要求",
      "if": {
        "properties": {
          "videoMeta": {
            "properties": {
              "contract": {
                "properties": {
                  "structure": {
                    "properties": { "requireTransitionT": { "const": true } },
                    "required": ["requireTransitionT"]
                  }
                },
                "required": ["structure"]
              }
            },
            "required": ["contract"]
          }
        },
        "required": ["videoMeta"]
      },
      "then": {
        "properties": {
          "scenes": {
            "type": "array",
            "contains": {
              "type": "object",
              "properties": { "type": { "const": "effect" }, "effectRole": { "const": "transition" } },
              "required": ["type", "effectRole"]
            }
          }
        }
      }
    },
    {
      "description": "contract.structure.requireClosingEffect===true のときだけ closing を要求",
      "if": {
        "properties": {
          "videoMeta": {
            "properties": {
              "contract": {
                "properties": {
                  "structure": {
                    "properties": { "requireClosingEffect": { "const": true } },
                    "required": ["requireClosingEffect"]
                  }
                },
                "required": ["structure"]
              }
            },
            "required": ["contract"]
          }
        },
        "required": ["videoMeta"]
      },
      "then": {
        "properties": {
          "scenes": {
            "type": "array",
            "contains": {
              "type": "object",
              "properties": { "type": { "const": "effect" }, "effectRole": { "const": "closing" } },
              "required": ["type", "effectRole"]
            }
          }
        }
      }
    },
    {
      "description": "scripturePrologueIntro=true の時、items[2]=Page3 Scripture, items[3]=Page4 Prologue を強制",
      "if": {
        "properties": {
          "videoMeta": {
            "properties": {
              "contract": {
                "properties": {
                  "structure": {
                    "properties": { "scripturePrologueIntro": { "const": true } },
                    "required": ["scripturePrologueIntro"]
                  }
                },
                "required": ["structure"]
              }
            },
            "required": ["contract"]
          }
        },
        "required": ["videoMeta"]
      },
      "then": {
        "properties": {
          "scenes": {
            "items": [
              {},
              {},
              {
                "allOf": [
                  { "$ref": "#/$defs/contentScene" },
                  {
                    "properties": {
                      "page": { "const": "3" },
                      "version": { "const": "A" },
                      "sectionTags": { "type": "array", "contains": { "const": "#Scripture" } }
                    },
                    "required": ["page", "version", "sectionTags"]
                  }
                ]
              },
              {
                "allOf": [
                  { "$ref": "#/$defs/contentScene" },
                  {
                    "properties": {
                      "page": { "const": "4" },
                      "version": { "const": "A" },
                      "sectionTags": { "type": "array", "contains": { "const": "#Prologue" } }
                    },
                    "required": ["page", "version", "sectionTags"]
                  }
                ]
              }
            ]
          }
        }
      }
    }
  ],

  "$defs": {
    "pageId": { "type": "string", "pattern": "^[1-9][0-9]*$" },
    "hexColor": { "type": "string", "pattern": "^#[0-9a-fA-F]{6}$" },

    "sectionTagTokenAny": {
      "type": "string",
      "pattern": "^#[A-Za-z0-9][A-Za-z0-9_-]{0,23}$"
    },

    "sectionTags": {
      "type": "array",
      "items": { "$ref": "#/$defs/sectionTagTokenAny" },
      "uniqueItems": true,
      "minItems": 1,
      "maxItems": 7,
      "description": "推奨3個。順序は表示順。"
    },

    "placeholderScene": {
      "type": "object",
      "description": "Page-1 のアクティベーションゲート（音声なし）。録画時はカットOK。タイトル等に絵文字・顔文字を入れても表示はOK、TTSは常に黙殺。",
      "properties": {
        "page": { "$ref": "#/$defs/pageId" },
        "type": { "type": "string", "const": "placeholder" },
        "title": { "type": "string" },
        "titleTTS": { "type": "string", "maxLength": 0, "default": "" },
        "narr": { "type": "string", "maxLength": 0, "default": "" },
        "narrTTS": { "type": "string", "maxLength": 0, "default": "" },
        "base": { "$ref": "#/$defs/hexColor" }
      },
      "required": ["page", "type"],
      "additionalProperties": false
    },

    "contentScene": {
      "type": "object",
      "description": "本文を持つ通常シーン（A/B/T）。type:'content'。**二層TTS（*TTS）必須**。表示テキストには絵文字・顔文字・記号の使用OK（視覚演出）。TTS 経路では自動で無音化される（安全）。",
      "properties": {
        "page": { "$ref": "#/$defs/pageId" },
        "type": { "type": "string", "const": "content" },
        "version": { "type": "string", "enum": ["A", "B", "T"] },

        "sectionTags": { "$ref": "#/$defs/sectionTags" },

        "title_key": { "type": "string", "pattern": "^\\u3010.+\\u3011$", "minLength": 2, "maxLength": 20 },
        "titleKeyTTS": { "type": "string", "minLength": 0, "maxLength": 40, "description": "タイトル鍵の読み。拗音はかな素直 or カタカナ拗音（例：『導入』→『どうニュー』）。" },

        "title": { "type": "string", "minLength": 1, "maxLength": 28 },
        "titleTTS": { "type": "string", "minLength": 1, "maxLength": 56, "description": "タイトルの読み（mirror 既定）。" },

        "symbol": { "type": "string", "minLength": 1, "maxLength": 16, "description": "絵文字/顔文字/短いシンボル（視覚演出）。TTS では黙殺される。" },
        "base": { "$ref": "#/$defs/hexColor" },

        "narr": { "type": "string", "maxLength": 280, "description": "表示用本文。絵文字/顔文字可（視覚演出）。" },
        "narrTTS": { "type": "string", "maxLength": 1200, "description": "読み上げ本文（mirror 既定：表示と意味一致）。句読点は policy に従ってスペースに変換可能。" },

        "effect": { "type": "string", "enum": ["light-in", "fade-in", "slide-up", "zoom-in"] },
        "durationHintMs": { "type": "integer", "minimum": 0 },

        "advancePolicy": {
          "type": "object",
          "description": "シーン個別の上書き。未指定時は videoMeta.advancePolicy を継承。",
          "properties": {
            "mode": { "type": "string", "enum": ["auto", "manual"] },
            "quietMs": { "type": "integer", "minimum": 0 },
            "postDelayMs": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        }
      },
      "required": [
        "page",
        "type",
        "version",
        "sectionTags",
        "title_key",
        "titleKeyTTS",
        "title",
        "titleTTS",
        "symbol",
        "base",
        "narr",
        "narrTTS"
      ],
      "additionalProperties": false,

      "allOf": [
        {
          "description": "最低1改行（リズム確保）",
          "properties": { "narr": { "pattern": ".*\\n.*" } }
        },
        {
          "description": "長文>=80では段落推奨（\\n\\n）",
          "if": { "properties": { "narr": { "minLength": 80 } }, "required": ["narr"] },
          "then": { "properties": { "narr": { "pattern": ".*\\n\\n.*" } } }
        }
      ]
    },

    "effectScene": {
      "type": "object",
      "description": "純エフェクト。本文キーは禁止。時間キーは t|duration|durationMs|effectDuration のいずれでも可。絵文字/顔文字は symbol 等を使わないため TTS 経路に影響なし。",
      "properties": {
        "page": { "$ref": "#/$defs/pageId" },
        "type": { "type": "string", "const": "effect" },
        "effect": {
          "type": "string",
          "enum": ["light-in", "fade-in", "fade-to-black", "flame-out", "veil-sweep", "slow-bloom", "slide-up", "zoom-in"]
        },
        "effectRole": { "type": "string", "enum": ["opening", "transition", "closing"] },
        "uiVersion": { "type": "string", "enum": ["A", "B", "T"] },
        "base": { "$ref": "#/$defs/hexColor" },

        "t": { "type": "integer", "minimum": 0 },
        "duration": { "type": "integer", "minimum": 0 },
        "durationMs": { "type": "integer", "minimum": 0 },
        "effectDuration": { "type": "integer", "minimum": 0 },

        "advancePolicy": {
          "type": "object",
          "description": "エフェクト終了後の挙動。未指定時は videoMeta.advancePolicy を継承。",
          "properties": {
            "mode": { "type": "string", "enum": ["auto", "manual"] },
            "quietMs": { "type": "integer", "minimum": 0 },
            "postDelayMs": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        }
      },
      "required": ["page", "type", "effect", "base"],
      "additionalProperties": false,

      "allOf": [
        {
          "description": "本文キーは禁止（効果のみ）",
          "not": {
            "anyOf": [
              { "required": ["title_key"] },
              { "required": ["titleKeyTTS"] },
              { "required": ["title"] },
              { "required": ["titleTTS"] },
              { "required": ["symbol"] },
              { "required": ["narr"] },
              { "required": ["narrTTS"] },
              { "required": ["sectionTags"] }
            ]
          }
        }
      ]
    }
  }
}